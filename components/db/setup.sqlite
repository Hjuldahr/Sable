-- Layer 1: Immutable Event Log (Discord / conversation)

CREATE TABLE IF NOT EXISTS DiscordGuilds (
    guild_id INTEGER PRIMARY KEY,
    guild_name TEXT,
    guild_description TEXT,
    nsfw_level TEXT, -- enum
    verification_level TEXT, -- enum
    filesize_limit INTEGER, -- bytes
    created_at INTEGER -- dtime
);

CREATE TABLE IF NOT EXISTS DiscordTextChannels (
    channel_id INTEGER PRIMARY KEY,
    guild_id INTEGER,
    channel_name TEXT,
    channel_topic TEXT,
    channel_type TEXT,
    is_nsfw INTEGER DEFAULT 0, -- Boolean
    created_at INTEGER, -- dtime
    permissions_json TEXT,
    FOREIGN KEY (guild_id) REFERENCES DiscordGuilds(guild_id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS DiscordMessage (
    message_id INTEGER PRIMARY KEY,
    user_id INTEGER,
    channel_id INTEGER,
    text TEXT,
    edited_at INTEGER NULL, -- dtime, null if unedited
    reactions TEXT DEFAULT '{}',              -- JSON blob
    created_at INTEGER DEFAULT (strftime('%s','now')),
    references_message_id INTEGER NULL, -- ID of message its replying to if any
    FOREIGN KEY (channel_id) REFERENCES DiscordTextChannels(channel_id) ON DELETE CASCADE,
    FOREIGN KEY (references_message_id) REFERENCES DiscordMessage(message_id) ON DELETE SET NULL
);

CREATE TABLE IF NOT EXISTS DiscordAttachments (
    attachment_id INTEGER PRIMARY KEY,
    message_id INTEGER,
    source_url TEXT, -- Location it was downloaded from
    source_proxy_url TEXT, 
    local_path TEXT, -- Location it was downloaded to
    title TEXT,
    content_type TEXT,
    file_name TEXT,
    description TEXT,
    is_spoiler INTEGER, -- Boolean,
    size INTEGER,
    FOREIGN KEY (message_id) REFERENCES DiscordMessage(message_id)
);

-- Layer 2: Long-term Identity / Persistent Memory

CREATE TABLE IF NOT EXISTS Persona (
    id INTEGER PRIMARY KEY CHECK(id = 1),
    user_id INTEGER DEFAULT 1452493514050113781,
    ai_name TEXT DEFAULT 'Sable',
    personality_traits TEXT DEFAULT '{}',   -- JSON blob
    updated_on INTEGER DEFAULT (strftime('%s','now')),
    subject_history TEXT DEFAULT '[]'       -- JSON blob of long-term topics
);

INSERT INTO Persona(id) VALUES(1) ON CONFLICT (id) DO NOTHING;

CREATE TABLE IF NOT EXISTS UserMemory (
    user_id INTEGER PRIMARY KEY,
    user_name TEXT,
    nickname TEXT,
    interaction_count INTEGER DEFAULT 0,
    last_seen_at INTEGER DEFAULT (strftime('%s','now'))
);

-- Layer 3: Transient / Runtime AI State

CREATE TABLE IF NOT EXISTS AIStateSnapshot (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    scope TEXT,             -- 'global', 'server', 'channel', 'user'
    scope_id INTEGER,       -- foreign key if applicable
    state_json TEXT,        -- stores runtime variables, mood, context, etc
    model_version TEXT,     -- version of the AI model
    created_at INTEGER DEFAULT (strftime('%s','now'))
);

CREATE TABLE IF NOT EXISTS PersonaTransient (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    entry TEXT,
    category TEXT,           -- e.g., like, dislike, interest
    added_on INTEGER DEFAULT (strftime('%s','now'))
);

CREATE TABLE IF NOT EXISTS UserMemoryTransient (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    entry TEXT,
    category TEXT,           -- e.g., like, dislike, learned fact
    added_on INTEGER DEFAULT (strftime('%s','now'))
);

-- Indexing

CREATE INDEX IF NOT EXISTS idx_DiscordMessage_channel ON DiscordMessage(channel_id);
CREATE INDEX IF NOT EXISTS idx_DiscordMessage_user ON DiscordMessage(user_id);
CREATE INDEX IF NOT EXISTS idx_DiscordAttachments_message ON DiscordAttachments(message_id);
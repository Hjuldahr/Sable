-- Layer 1: Immutable Event Log (Discord / conversation)

CREATE TABLE IF NOT EXISTS DiscordGuilds (
    guild_id INTEGER PRIMARY KEY,
    guild_name TEXT,
    guild_description TEXT,
    nsfw_level INTEGER, -- enum
    verification_level INTEGER, -- enum
    filesize_limit INTEGER, -- bytes
    created_at INTEGER -- dtime
);

CREATE TABLE IF NOT EXISTS DiscordTextChannels (
    channel_id INTEGER PRIMARY KEY,
    guild_id INTEGER,
    channel_name TEXT,
    channel_topic TEXT,
    channel_type INTEGER -- enum,
    permissions_json TEXT,
    is_nsfw INTEGER DEFAULT 0, -- Boolean
    created_at INTEGER, -- dtime
    FOREIGN KEY (guild_id) REFERENCES DiscordGuilds(guild_id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS DiscordMessage (
    message_id INTEGER PRIMARY KEY,
    user_id INTEGER NOT NULL,
    channel_id INTEGER NOT NULL,
    guild_id INTEGER NOT NULL,

    content TEXT,                 -- cleaned message text
    token_count INTEGER NOT NULL, -- precomputed for LLM budgeting

    reference_message_id INTEGER NULL,

    created_at INTEGER NOT NULL,
    edited_at INTEGER NULL,

    FOREIGN KEY (guild_id) REFERENCES DiscordGuilds(guild_id) ON DELETE CASCADE,
    FOREIGN KEY (channel_id) REFERENCES DiscordTextChannels(channel_id) ON DELETE CASCADE,
    FOREIGN KEY (reference_message_id) REFERENCES DiscordMessage(message_id) ON DELETE SET NULL
);

CREATE TABLE IF NOT EXISTS DiscordMessageMentions (
    message_id INTEGER NOT NULL,

    mention_text TEXT NOT NULL, -- @Everyone, @Here, @Sable, #channel-name
    mention_id INTEGER NULL,    -- user_id, channel_id, role_id, or NULL

    PRIMARY KEY (message_id, mention_id, mention_text),
    FOREIGN KEY (message_id) REFERENCES DiscordMessage(message_id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS DiscordReactions (
    message_id INTEGER NOT NULL,
    emoji TEXT NOT NULL,
    count INTEGER NOT NULL,
    users_json TEXT NOT NULL,

    PRIMARY KEY (message_id, emoji),
    FOREIGN KEY (message_id) REFERENCES DiscordMessage(message_id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS DiscordAttachments (
    attachment_id INTEGER PRIMARY KEY,
    message_id INTEGER NOT NULL,

    source_url TEXT,
    source_proxy_url TEXT,
    local_path TEXT,

    file_name TEXT,
    content_type TEXT,
    size INTEGER,
    is_spoiler INTEGER DEFAULT 0,

    title TEXT,
    markdown TEXT,

    FOREIGN KEY (message_id) REFERENCES DiscordMessage(message_id) ON DELETE CASCADE
);

-- Layer 2: Long-term Identity / Persistent Memory

CREATE TABLE IF NOT EXISTS Persona (
    id INTEGER PRIMARY KEY CHECK(id = 1),
    user_id INTEGER DEFAULT 1452493514050113781,
    ai_name TEXT DEFAULT 'Sable',
    personality_traits TEXT DEFAULT '{}',   -- JSON blob
    updated_on INTEGER DEFAULT (strftime('%s','now')),
    subject_history TEXT DEFAULT '[]'       -- JSON blob of long-term topics
);

INSERT INTO Persona(id) VALUES(1) ON CONFLICT (id) DO NOTHING;

CREATE TABLE IF NOT EXISTS UserMemory (
    user_id INTEGER PRIMARY KEY,
    user_name TEXT,
    nickname TEXT,
    interaction_count INTEGER DEFAULT 0,
    last_seen_at INTEGER DEFAULT (strftime('%s','now'))
);

-- Layer 3: Transient / Runtime AI State

CREATE TABLE IF NOT EXISTS PersonaTransient (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    entry TEXT,
    category TEXT,           -- e.g., likes, dislikes, interests
    added_on INTEGER DEFAULT (strftime('%s','now'))
);

CREATE TABLE IF NOT EXISTS UserMemoryTransient (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    entry TEXT,
    category TEXT,           -- e.g., likes, dislikes, learned facts
    added_on INTEGER DEFAULT (strftime('%s','now'))
);

-- Indexing

CREATE INDEX IF NOT EXISTS idx_msg_channel_time ON DiscordMessage(channel_id, created_at);
CREATE INDEX IF NOT EXISTS idx_msg_user ON DiscordMessage(user_id);
CREATE INDEX IF NOT EXISTS idx_msg_reference ON DiscordMessage(reference_message_id);
CREATE INDEX IF NOT EXISTS idx_mentions_message ON DiscordMessageMentions(message_id);
CREATE INDEX IF NOT EXISTS idx_attachments_message ON DiscordAttachments(message_id);
CREATE INDEX IF NOT EXISTS idx_reactions_message ON DiscordReactions(message_id);